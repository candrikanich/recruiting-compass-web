image: node:20-alpine

stages:
  - build
  - commit

variables:
  NODE_ENV: production
  CI: "true"

cache:
  paths:
    - node_modules/

# Build stage - creates .output directory
build:web:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - .output/
    expire_in: 30 minutes
  only:
    - main

# Commit build output back to git
commit:output:
  stage: commit
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - git config --global user.email "ci@recruting-compass.com"
    - git config --global user.name "GitLab CI"
  script:
    - git clone --depth 1 https://oauth2:$CI_JOB_TOKEN@gitlab.com/the-recruiting-compass/recruiting-compass-web.git repo
    - cd repo
    - rm -rf .output
    - cp -r ../.output .
    - git add .output/
    - git commit -m "build: rebuild output for Netlify deployment [skip ci]" || true
    - git push https://oauth2:$CI_JOB_TOKEN@gitlab.com/the-recruiting-compass/recruiting-compass-web.git HEAD:main
  needs:
    - build:web
  only:
    - main
  dependencies:
    - build:web
