image: node:20-alpine

stages:
  - build

variables:
  NODE_ENV: production
  CI: "true"

cache:
  paths:
    - node_modules/

# Build stage - creates .output directory
build:web:
  stage: build
  script:
    - npm ci
    - npm run build
  after_script:
    - apk add --no-cache git
    - git config --global user.email "ci@recruiting-compass.com"
    - git config --global user.name "GitLab CI"
    - git clone --depth 1 https://oauth2:$CI_JOB_TOKEN@gitlab.com/the-recruiting-compass/recruiting-compass-web.git repo
    - cd repo
    - rm -rf .output
    - cp -r ../.output .
    - git add .output/
    - git commit -m "build: rebuild output for Netlify deployment [skip ci]" || true
    - git push https://oauth2:$CI_JOB_TOKEN@gitlab.com/the-recruiting-compass/recruiting-compass-web.git HEAD:main
  only:
    - main
